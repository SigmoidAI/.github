name: Update Organization Contributors in README

on:
  schedule:
    - cron: "0 0 1 * *"  # Runs on the 1st of each month
  workflow_dispatch: # Allows manual triggering

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: Fetch all repositories in the organization
        run: |
          echo "Fetching all repositories..."
          gh repo list SigmoidAI --limit 100 --json name -q '.[].name' > repos.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch contributors for all repositories
        run: |
          echo "# Organization Contributors" > CONTRIBUTORS.md
          echo "This is an auto-generated list of contributors from all repositories." >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md

          while IFS= read -r repo; do
            echo "Processing repository: $repo"
            gh api repos/SigmoidAI/$repo/contributors --paginate --jq '.[].login' | sort -u > tmp_contributors.txt

            if [ -s tmp_contributors.txt ]; then
              echo "### $repo" >> CONTRIBUTORS.md
              while IFS= read -r contributor; do
                echo "- @$contributor" >> CONTRIBUTORS.md
              done < tmp_contributors.txt
              echo "" >> CONTRIBUTORS.md
            fi
          done < repos.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add CONTRIBUTORS.md
          git commit -m "Updated contributors list for all organization repositories" || echo "No changes to commit"
          git push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
