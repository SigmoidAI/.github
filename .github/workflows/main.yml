name: Update Organization Contributors with Local Commits Only
on:
  schedule:
    - cron: "0 0 1 * *"  # Runs on the 1st of each month
  workflow_dispatch: # Allows manual triggering

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh jq

      - name: Fetch and process contributors
        run: |
          # Initialize contributors file
          echo "# Organization Contributors" > CONTRIBUTORS.md
          echo "This list shows total contributions across all repositories in the organization." >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          
          # Create temporary file for storing all contributions
          touch all_contributions.txt
          
          # Fetch all repositories in the organization
          gh repo list SigmoidAI --json name,isFork,defaultBranch --jq '.[]' > repos.json
          
          # Process each repository
          while IFS= read -r repo_data; do
            repo_name=$(echo "$repo_data" | jq -r '.name')
            is_fork=$(echo "$repo_data" | jq -r '.isFork')
            echo "Processing repository: $repo_name"
            
            if [ "$is_fork" = "true" ]; then
              # For forked repos, we need to get the fork creation date
              fork_date=$(gh api repos/SigmoidAI/$repo_name --jq '.created_at')
              
              # Get all commits after fork date
              gh api repos/SigmoidAI/$repo_name/commits --paginate \
                --since "$fork_date" \
                --jq '.[] | select(.author != null) | {login: .author.login, date: .commit.author.date}' > repo_commits.json
              
              # Count commits per author
              jq -r '.login' repo_commits.json | sort | uniq -c | while read -r count login; do
                [ ! -z "$login" ] && echo "$login $count" >> all_contributions.txt
              done
            else
              # For non-forked repos, get all contributors
              gh api repos/SigmoidAI/$repo_name/contributors --paginate \
                --jq '.[] | select(.login != null) | {login: .login, contributions: .contributions}' > repo_contributors.json
              
              # Add contributions to total
              jq -r '. | "\(.login) \(.contributions)"' repo_contributors.json >> all_contributions.txt
            fi
          done < <(jq -c '.' repos.json)
          
          # Sum up all contributions and sort
          awk '{contrib[$1] += $2} END {for (author in contrib) print author, contrib[author]}' all_contributions.txt | \
            sort -k2 -nr | \
            while read -r author commits; do
              echo "- @$author: $commits contributions" >> CONTRIBUTORS.md
            done
          
          # Clean up temporary files
          rm -f repos.json repo_commits.json repo_contributors.json all_contributions.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add CONTRIBUTORS.md
          git commit -m "Updated contributors list" || echo "No changes to commit"
          git push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
